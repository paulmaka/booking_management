<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Fantasy Tavern</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root{
            --bg-image: url("background.png");

            --burgundy:#7B1E28;
            --gold: #edeff3;
            --emerald:#166D3B;
            --ivory:#F8F4E3;
            --charcoal:#3D3D3D;
            --sage:#98AE87;
            --rose:#B77C87;

            --text:var(--ivory);
            --muted:#e6dfcf;
            --br:rgba(196,169,91,.35);

            --card:rgba(12,12,14,.50);
            --card-strong:rgba(12,12,14,.62);

            --pri:var(--emerald);
            --pri-2:#0f4f2a;
            --ok:#88d39e;
            --err:#e07a7a;
        }

        html,body{height:100%}

        body{
            font-family: Inter, Arial, sans-serif;
            background: var(--bg-image) center/cover no-repeat fixed, #0e0f13;
            color: var(--text);
            margin:0; min-height:100vh;
            display:flex; align-items:center; justify-content:center;
        }

        .bg{display:none}
        .overlay{
            position:fixed; inset:0;
            background: radial-gradient(ellipse at 50% 18%, rgba(0,0,0,.08), rgba(0,0,0,.58) 60%, rgba(0,0,0,.72));
            pointer-events:none;
        }

        .wrap{width:100%;max-width:980px;padding:20px;position:relative;z-index:2}
        .shell{
            background:var(--card-strong);
            border:1px solid var(--br);
            border-radius:20px;
            box-shadow:0 20px 60px rgba(0,0,0,.45);
            backdrop-filter: blur(10px);
            overflow:hidden;
        }
        .top{
            display:flex;align-items:center;justify-content:space-between;
            padding:16px 20px;border-bottom:1px solid var(--br);
            background:linear-gradient(0deg, transparent, rgba(0,0,0,.25));
        }
        .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.3px;color:var(--gold)}
        .brand img{width:36px;height:36px;filter: drop-shadow(0 2px 4px rgba(0,0,0,.35))}
        .userbox{display:flex;align-items:center;gap:12px}
        .muted{color:var(--muted)}

        .content{display:grid;grid-template-columns:1fr 1fr;gap:20px;padding:20px}

        .card{
            background:var(--card);
            border:1px solid var(--br);
            border-radius:16px;
            padding:20px;
            box-shadow:0 10px 30px rgba(0,0,0,.35);
            backdrop-filter: blur(6px);
        }

        .hero{display:flex;flex-direction:column;justify-content:center;gap:18px}
        .hero h1{margin:0;font-size:28px;line-height:1.2;color:var(--gold)}
        .hero p{margin:0;color:var(--muted)}
        .imgbox{border-radius:16px;overflow:hidden;border:1px solid var(--br);background:rgba(255,255,255,.04)}
        .imgbox svg{display:block;width:100%;height:100%}

        .hidden{display:none!important}

        .btn{
            background:var(--pri);
            color:var(--ivory);
            border:1px solid rgba(255,255,255,.08);
            border-radius:12px;
            padding:10px 14px;
            font-weight:700;
            cursor:pointer;
            transition:.15s transform ease,.15s filter ease,.15s background-color ease;
        }
        .btn:hover{filter:brightness(1.05)}
        .btn:active{transform:translateY(1px)}
        .btn[disabled]{opacity:.55;cursor:not-allowed}
        .btn-secondary{background:transparent;color:var(--ivory);border-color:var(--gold)}
        .btn-secondary:hover{background: rgba(196,169,91,.12)}

        input,select{
            padding:12px 12px;
            border:1px solid var(--br);
            border-radius:12px;
            outline:none;
            background: rgba(255,255,255,.06);
            color:var(--ivory);
        }
        input::placeholder{color:rgba(248,244,227,.6)}
        input:focus,select:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(196,169,91,.18)}

        .error{color:var(--err);min-height:18px;font-size:12px;margin-top:8px}
        .ok{color:var(--ok);min-height:18px;font-size:12px;margin-top:8px}

        .tables{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
        .tablebtn{
            position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;
            padding:14px;border-radius:14px;border:1px solid var(--br);
            background: rgba(255,255,255,.05);
            cursor:not-allowed;opacity:.55;transition:.15s;
            color:var(--ivory)
        }
        .tablebtn.active{cursor:pointer;opacity:1;background:rgba(22,109,59,.18);border-color:rgba(22,109,59,.45)}
        .tablebtn.selected{background:var(--burgundy);border-color:var(--burgundy);color:#fff}
        .tablebtn .num{margin-top:8px;font-weight:800}
        .tablebtn svg{width:56px;height:56px}

        .auth h2{text-align:center;margin:0 0 12px;color:var(--gold)}
        .centerbox{max-width:420px;margin:0 auto;padding:24px}
        .toggle{margin-top:12px;text-align:center;color:var(--sage);cursor:pointer}

        @media (max-width:920px){.content{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="overlay"></div>

<div class="wrap">
    <div class="shell">
        <div class="top">
            <div class="brand">
                <img alt="logo" src="data:image/svg+xml;utf8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop stop-color='%237B1E28'/><stop offset='1' stop-color='%23C4A95B'/></linearGradient></defs><rect width='120' height='120' rx='24' fill='url(%23g)'/><path d='M30 80h60M40 70h40M50 30l10 14h-8l8 12h-10' stroke='%23F8F4E3' stroke-width='6' stroke-linecap='round' fill='none'/></svg>">
                <span>Fantasy Tavern</span>
            </div>
            <div class="userbox">
                <span id="user-email" class="muted"></span>
                <button id="logout-btn" class="btn btn-secondary hidden">Выйти</button>
            </div>
        </div>

        <div id="view-auth" class="auth">
            <div class="centerbox">
                <h2 id="form-title">Вход</h2>
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="Email" required />
                    <input type="password" id="login-password" placeholder="Пароль" required />
                    <button type="submit" class="btn" style="width:100%">Войти</button>
                    <div class="error" id="login-error"></div>
                    <div class="ok" id="login-ok"></div>
                </form>
                <form id="register-form" class="hidden">
                    <input type="text" id="register-username" placeholder="Имя" required />
                    <input type="email" id="register-email" placeholder="Email" required />
                    <input type="password" id="register-password" placeholder="Пароль" required />
                    <button type="submit" class="btn" style="width:100%">Создать аккаунт</button>
                    <div class="error" id="register-error"></div>
                    <div class="ok" id="register-ok"></div>
                </form>
                <div class="toggle" id="toggle-link">Создать аккаунт</div>
            </div>
        </div>

        <div id="view-home" class="content hidden">
            <div class="card hero">
                <h1>Добро пожаловать в Fantasy Tavern</h1>
                <p>Гул голосов, звон кружек и лучшая компания со всех миров. Забронируйте столик.</p>
                <div class="actions">
                    <button id="go-booking" class="btn">Забронировать</button>
                </div>
                <div id="last-booking" class="muted"></div>
            </div>
            <div class="imgbox">
                <svg viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="fantasy-tavern">
                    <defs><linearGradient id="g1" x1="0" x2="1"><stop stop-color="#3d3d3d"/><stop offset="1" stop-color="#0e0f13"/></linearGradient></defs>
                    <rect width="800" height="500" fill="url(#g1)"/>
                    <g opacity=".18"><circle cx="650" cy="120" r="90" fill="#166D3B"/><circle cx="200" cy="360" r="120" fill="#7B1E28"/><rect x="340" y="200" width="220" height="140" rx="18" fill="#C4A95B"/></g>
                </svg>
            </div>
        </div>

        <div id="view-booking" class="content hidden">
            <div class="grid">
                <div class="card formcol">
                    <h3 style="margin:0 0 12px;color:var(--gold)">Выбор времени</h3>
                    <form id="time-form">
                        <input type="datetime-local" id="book-time" required />
                        <button type="submit" class="btn">Показать свободные столы</button>
                        <div class="error" id="time-error"></div>
                    </form>
                    <div style="height:12px"></div>
                    <h3 style="margin:12px 0;color:var(--gold)">Столы</h3>
                    <div id="tables" class="tables"></div>
                </div>
                <div class="card formcol">
                    <h3 style="margin:0 0 12px;color:var(--gold)">Данные клиента</h3>
                    <form id="booking-form">
                        <input type="text" id="client-name" placeholder="Имя" required />
                        <input type="email" id="client-email" placeholder="Email" required />
                        <input type="hidden" id="selected-table" />
                        <button type="submit" id="confirm-btn" class="btn" disabled>Подтвердить</button>
                        <div class="error" id="booking-error"></div>
                        <div class="ok" id="booking-ok"></div>
                    </form>
                    <div class="muted" style="margin-top:12px" id="back-home">← На главную</div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const AUTH_BASE = '/auth'
    const BOOKING_BASE = '/booking'
    const state={token:localStorage.getItem('token')||null,email:localStorage.getItem('email')||'',available:new Set(),selectedTable:null,bookTime:null,lastBooking:JSON.parse(localStorage.getItem('lastBooking')||'null')}
    const el=(id)=>document.getElementById(id)
    const viewAuth=el('view-auth'), viewHome=el('view-home'), viewBooking=el('view-booking')
    const userEmail=el('user-email'), logoutBtn=el('logout-btn'), goBooking=el('go-booking'), lastBookingBox=el('last-booking')
    const timeForm=el('time-form'), bookTimeInput=el('book-time'), timeError=el('time-error'), tablesBox=el('tables')
    const bookingForm=el('booking-form'), clientName=el('client-name'), clientEmail=el('client-email'), bookingError=el('booking-error'), bookingOk=el('booking-ok')
    const selectedTableHidden=el('selected-table'), confirmBtn=el('confirm-btn'), backHome=el('back-home')
    const loginForm=el('login-form'), registerForm=el('register-form'), toggleLink=el('toggle-link'), formTitle=el('form-title')
    const loginError=el('login-error'), loginOk=el('login-ok'), registerError=el('register-error'), registerOk=el('register-ok')

    function show(id){ viewAuth.classList.add('hidden'); viewHome.classList.add('hidden'); viewBooking.classList.add('hidden'); id.classList.remove('hidden') }
    function setAuth(email,token){ state.email=email; state.token=token; localStorage.setItem('token',token); localStorage.setItem('email',email); userEmail.textContent=email||''; logoutBtn.classList.toggle('hidden',!token) }

    function formatBookDate(s){
        if(!s) return ''
        const cleaned = s.trim().replace(' ', 'T').replace(/\.\d+$/, '')
        const d = new Date(cleaned)
        return isNaN(d) ? s : d.toLocaleString()
    }

    function renderHome(){
        userEmail.textContent=state.email||''
        logoutBtn.classList.toggle('hidden',!state.token)
        if(state.lastBooking){
            const b=state.lastBooking
            const when=formatBookDate(b.bookDate || b.bookTime)
            lastBookingBox.innerHTML=`Ваша бронь: <b>${b.name}</b>, стол ${b.table}, ${when}, номер: ${b.bookId}`
        }else lastBookingBox.textContent=''
    }

    function tableSvg(active,selected){
        const stroke=selected?'#ffffff':active?'#C4A95B':'#6b6b6b'
        const fillTop=selected?'#ffffff':active?'rgba(196,169,91,.25)':'rgba(255,255,255,.08)'
        const fillSeat=selected?'#ffffff':active?'rgba(22,109,59,.25)':'rgba(255,255,255,.06)'
        return `
      <svg viewBox="0 0 64 64" aria-hidden="true">
        <rect x="10" y="22" width="44" height="20" rx="6" fill="${fillTop}" stroke="${stroke}" stroke-width="2"></rect>
        <rect x="6" y="12" width="12" height="12" rx="4" fill="${fillSeat}" stroke="${stroke}" stroke-width="1.5"></rect>
        <rect x="46" y="12" width="12" height="12" rx="4" fill="${fillSeat}" stroke="${stroke}" stroke-width="1.5"></rect>
        <rect x="6" y="40" width="12" height="12" rx="4" fill="${fillSeat}" stroke="${stroke}" stroke-width="1.5"></rect>
        <rect x="46" y="40" width="12" height="12" rx="4" fill="${fillSeat}" stroke="${stroke}" stroke-width="1.5"></rect>
      </svg>
    `
    }

    function renderTables(){
        tablesBox.innerHTML=''
        const ids=Array.from({length:7},(_,i)=>String(i+1))
        ids.forEach(n=>{
            const active=state.available.has(n)
            const selected=state.selectedTable===n
            const btn=document.createElement('button')
            btn.className='tablebtn'+(active?' active':'')+(selected?' selected':'')
            btn.disabled=!active
            btn.innerHTML=`${tableSvg(active,selected)}<div class="num">Стол ${n}</div>`
            btn.onclick=()=>{
                if(!active) return
                state.selectedTable=n
                selectedTableHidden.value=n
                Array.from(tablesBox.children).forEach(c=>c.classList.remove('selected'))
                btn.classList.add('selected')
                updateConfirmState()
            }
            tablesBox.appendChild(btn)
        })
    }

    function updateConfirmState(){
        const ready=Boolean(state.bookTime && state.selectedTable && clientName.value.trim() && clientEmail.value.trim())
        confirmBtn.disabled=!ready
    }

    async function jsonOrText(res){ const ct=res.headers.get('content-type')||''; if(ct.includes('application/json')) return res.json(); return res.text() }
    function join(base, path){ if(!path) return base; return base.replace(/\/$/, '') + '/' + String(path).replace(/^\//,'') }
    async function bookingFetch(path, opts = {}){ const headers = opts.headers || {}; if(state.token) headers['Authorization'] = 'Bearer ' + state.token; return fetch(join(BOOKING_BASE, path), { ...opts, headers }) }

    toggleLink.addEventListener('click',()=>{
        const toRegister=registerForm.classList.contains('hidden')
        registerForm.classList.toggle('hidden',!toRegister?true:false)
        loginForm.classList.toggle('hidden',toRegister?true:false)
        formTitle.textContent=toRegister?'Регистрация':'Вход'
        toggleLink.textContent=toRegister?'Уже есть аккаунт? Войти':'Создать аккаунт'
        ;[loginError,loginOk,registerError,registerOk].forEach(e=>e.textContent='')
    })

    document.getElementById('login-form').addEventListener('submit',async(e)=>{
        e.preventDefault(); loginError.textContent=''; loginOk.textContent=''
        try{
            const email=document.getElementById('login-email').value.trim()
            const password=document.getElementById('login-password').value
            const res=await fetch(`${AUTH_BASE}/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})})
            const body=await jsonOrText(res)
            if(!res.ok) throw new Error(typeof body==='string'?body:(body?.message||'Ошибка входа'))
            const token=body.token
            setAuth(email,token); show(viewHome); renderHome(); loginOk.textContent='Успешный вход.'
        }catch(err){loginError.textContent=err.message}
    })

    document.getElementById('register-form').addEventListener('submit',async(e)=>{
        e.preventDefault(); registerError.textContent=''; registerOk.textContent=''
        try{
            const username=document.getElementById('register-username').value.trim()
            const email=document.getElementById('register-email').value.trim()
            const password=document.getElementById('register-password').value
            const res=await fetch(`${AUTH_BASE}/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,email,password})})
            const body=await jsonOrText(res)
            if(!res.ok) throw new Error(typeof body==='string'?body:(body?.message||'Ошибка регистрации'))
            const token=body.token
            setAuth(email,token); show(viewHome); renderHome(); registerOk.textContent='Аккаунт создан.'
        }catch(err){registerError.textContent=err.message}
    })

    logoutBtn.addEventListener('click',()=>{ localStorage.removeItem('token'); localStorage.removeItem('email'); setAuth('',null); location.reload() })
    goBooking.addEventListener('click',()=>{ state.available=new Set(); state.selectedTable=null; state.bookTime=null; bookTimeInput.value=''; bookingError.textContent=''; bookingOk.textContent=''; timeError.textContent=''; clientName.value=state.email?state.email.split('@')[0]:''; clientEmail.value=state.email||''; selectedTableHidden.value=''; renderTables(); updateConfirmState(); show(viewBooking) })
    backHome.addEventListener('click',()=>{ show(viewHome); renderHome() })

    timeForm.addEventListener('submit', async (e) => {
        e.preventDefault(); timeError.textContent = ''
        try{
            const raw = bookTimeInput.value.trim(); if(!raw) throw new Error('Выберите время')
            const local = raw.length === 16 ? raw + ':00' : raw
            state.bookTime = local
            const res = await bookingFetch('time', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ bookTime: local }) })
            const body = await jsonOrText(res)
            if(!res.ok) throw new Error(typeof body === 'string' ? body : (body?.message || 'Не удалось получить столы'))
            const ids = (Array.isArray(body) ? body : []).map(x => String(x.id))
            state.available = new Set(ids); state.selectedTable = null; selectedTableHidden.value = ''; renderTables(); updateConfirmState()
        }catch(err){ timeError.textContent = err.message }
    })

    bookingForm.addEventListener('input',updateConfirmState)

    bookingForm.addEventListener('submit', async (e) => {
        e.preventDefault(); bookingError.textContent = ''; bookingOk.textContent = ''
        try{
            if(!state.bookTime) throw new Error('Сначала выберите время')
            if(!state.selectedTable) throw new Error('Выберите стол')
            const payload = { name: clientName.value.trim(), email: clientEmail.value.trim(), bookTime: state.bookTime, table: Number(state.selectedTable) }
            const res = await bookingFetch('', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
            const body = await jsonOrText(res)
            if(!res.ok) throw new Error(typeof body === 'string' ? body : (body?.message || 'Не удалось создать бронь'))
            state.lastBooking = body; localStorage.setItem('lastBooking', JSON.stringify(body)); bookingOk.textContent = 'Бронь подтверждена'; show(viewHome); renderHome()
        }catch(err){ bookingError.textContent = err.message }
    })

    ;(function boot(){ userEmail.textContent=state.email||''; logoutBtn.classList.toggle('hidden',true); show(viewAuth) })()
</script>
</body>
</html>
